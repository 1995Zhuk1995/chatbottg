# Вопросно-ответная диалоговая система (чатбот)

## Краткое описание

Чатбот это набор инструментов, позволяющих организовывать диалоговые сессии
пользователя примерно такого вида:

```
B:> Привет, буду рад поговорить
H:> Как тебя зовут?
B:> кеша
B:> А как тебя зовут?
H:> Меня зовут Илья.
B:> Приятно познакомиться.
H:> Сколько будет 2 плюс 2?
B:> 4
H:> Меня как зовут?
B:> илья
H:> Сколько сейчас времени?
B:> 17 часов 47 минут
```

В этом примере реплики чатбота отмечены символами B:>, а реплики человека - символами H:>.

Основные особенности чатбота:

1) Новая информация (факты), сообщаемые пользователем, могут немедленно добавляться
в базу знаний и использоваться в последующих ответах наряду с остальными фактами. Именно так
в базу знаний бота попадает имя собеседника, которое он сообщает. Переобучение моделей
при этом не требуется.

2) Сессионность: сообщаемые пользователем факты сохраняются в отдельном разделе
базы знаний, привязанном к пользователю, так что сессии для разных пользователей
могут оперировать противоречащей или конфиденциальной информацией.

3) Ориентированность на клиент-серверный механизм; способ доставки сообщений отвязан от
ядра системы и может быть реализован в виде текстовой консоли, бота для мессенджера,
браузерного клиента для веб-сервиса и т.д.

4) Ответы чатбота не программируются скриптами или аналогичными средствами, а генерируются
обучаемыми моделями. В необходимых случаях используются нейросетевые deep learning модели,
а также классические NLP алгоритмы.

5) Архитектура движка чатбота полностью отделена от каналов доставки сообщений. Например, есть
варианты чатботов для [консоли](console_chatbot.py) и в виде [веб-сервиса](flask_service_bot.py).

Благодаря использованию [посимвольных встраиваний для слов](./PyModels/trainers/README.wordchar2vector.md)
чатбот можно обучить отвечать даже на вопросы, относящиеся к символьному представлению слов:

```
B:> Привет, буду рад пообщаться
H:> сколько букв в слове мама?
B:> 4
```

В более широком смысле посимвольные встраивания для слов позволяют боту лучше учитывать
некоторые лексические особенности русского языка, в частности - однокоренные слова.

Специальная модель интерпретации ответов собеседника позволяет чатботу понимать неполные реплики,
опираясь на контекст беседы, и далее учитывать их как обычные факты:

```
B:> Здравствуй
H:> как тебя зовут?
B:> кеша
B:> А как тебя зовут?
H:> илья
B:> Приятно познакомиться.
H:> как меня зовут?
B:> илья
```

В данном примере чатбот задает вопрос "А как тебя зовут", рассчитывая заполнить пробел в своей базе
знаний. Собеседник сообщает свое имя, и его ответ интерпретируется как "Меня зовут Илья".
Эта реплика рассматривается как полноценный факт и запоминается в базе знаний, что видно
на последних двух репликах диалога, где собеседник спрашивает у бота свое имя и получает его.

Способ генерации ответа выбирается в зависимости от контекста. В частности,
чатбот может выполнять простые арифметические операции:

```
B:> Привет, буду рад поговорить
H:> Чему равно 2 плюс 3?
B:> 5
```

## Консольный фронтенд для бота

Реализован в файле [console_chatbot.py](https://github.com/Koziev/chatbot/blob/master/PyModels/console_chatbot.py).
Запуск под Linux выполняется скриптом scripts/console_bot.sh

![Console frontend for chatbot](chatbot-console.PNG)

Это отладочная консоль, в которую помимо реплик чатбота выводятся также различные диагностические сообщения.

## Технические подробности реализации

Список моделей:

Посимвольное встраивание слово в вектор фиксированной длины [wordchar2vector_model.py](https://github.com/Koziev/chatbot/tree/master/PyModels/bot/wordchar2vector_model.py)  
Определение способа генерации ответа [nn_model_selector.py](https://github.com/Koziev/chatbot/tree/master/PyModels/bot/nn_model_selector.py)  
Определение слов, копируемых из предпосылки в ответ [nn_wordcopy3.py](https://github.com/Koziev/chatbot/tree/master/PyModels/bot/nn_wordcopy3.py)  
Определение достаточности набора предпосылок для генерации ответа [nn_enough_premises_model.py](https://github.com/Koziev/chatbot/tree/master/PyModels/bot/nn_enough_premises_model.py)  
Генерация ответов yes/no [nn_yes_no_model.py](https://github.com/Koziev/chatbot/tree/master/PyModels/bot/nn_yes_no_model.py)  
Посимвольная генерация ответа [xgb_answer_generator_model.py](https://github.com/Koziev/chatbot/tree/master/PyModels/bot/xgb_answer_generator_model.py)  
Определение грамматического лица фразы [xgb_person_classifier_model.py](https://github.com/Koziev/chatbot/tree/master/PyModels/bot/xgb_person_classifier_model.py)  
Определение релевантности предпосылки и вопроса [lgb_relevancy_detector.py](https://github.com/Koziev/chatbot/tree/master/PyModels/bot/lgb_relevancy_detector.py)  
Интерпретация реплики собеседника (раскрытие анафоры, дополнение ответа etc) [nn_interpreter.py](https://github.com/Koziev/chatbot/tree/master/PyModels/bot/nn_interpreter.py)  
Определение синонимии фраз [nn_synonymy_detector.py](https://github.com/Koziev/chatbot/tree/master/PyModels/bot/nn_synonymy_detector.py)  

Набор моделей и конкретная реализация могут сильно меняться по мере развития проекта,
поэтому список является не окончательным.

Описание тренировки и использования модели посимвольного встраивания слов
смотрите на [отдельной странице](./PyModels/trainers/README.wordchar2vector.md).

Также доступно [описание модели для определения релевантности факта и вопроса](README.relevance.md).

## Pretrained models

Модель встраивания слов в векторное пространство тренируется с помощью
скрипта https://gist.github.com/Koziev/e39689adec30ae5bf6afaa1ca47c08e5 (Python, gensim)
и текстового корпуса размером около 10 Гб, в котором текст предварительно разбит
на слова и приведен к нижнему регистру.

Все необходимые файлы моделей, которые тренируются на диалоговых корпусах и используются
чатботом, выложены в [папке tmp репозитория](https://github.com/Koziev/chatbot/tree/master/tmp).

Скрипты запуска бота, например [console_bot.sh](https://github.com/Koziev/chatbot/blob/master/scripts/console_bot.sh)
указывают именно этот подкаталог в качестве местоположения моделей. Таким образом, после скачивания репозитория
чатбот должен быть доступен для использования без предварительного обучения.
